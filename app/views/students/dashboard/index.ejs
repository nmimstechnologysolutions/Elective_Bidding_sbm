<%- include("../partials/head") %>
<%- include("../partials/leftSidebar") %>
<%- include("../partials/header") %>

<style>

.card-title{
    font-size: 18px !important;
    font-weight: 500 !important;
}

.info-title{
    font-size: 24px;
    margin-top: -6px;
    font-weight: 600;
    margin-left: 6px;
    text-transform: capitalize;
}

.accordion {
    --bs-accordion-bg: #fff;
    --bs-accordion-active-bg: #fff;
    --bs-accordion-active-color: #000;
    --bs-accordion-border-width: none;
    --bs-accordion-body-padding-x: 0;
    --bs-accordion-body-padding-y: 15px;
    --bs-accordion-btn-focus-box-shadow: none;
    --bs-accordion-btn-padding-x: 0;
    --bs-accordion-btn-padding-y: 0;
    --bs-accordion-btn-color: #000;
}


.loader{
    display: none;
    position: absolute;
    left: 50%;
    top: 35%;
    transform: translate(-50%, -50%); 
    /* top: 10%;
    left: 50%;
    transform: translate(-50%, -50%);  */
    z-index: 1000;
}

.loader img{
    height: 50px;
    height: 50px;
}

.star label {
    box-shadow: 0px 0px 0px 0px rgba(253,192,47,0.5);
}
.star label:after {
    content: "\f005";
}
.star input:checked + label {
    background-color: #fdc02f;
    border-color: #fdc02f;
    box-shadow: 0px 0px 0px .5em rgba(253,192,47,0);
}
.star input:checked + label:after {
    color: #fdc02f;
}

.anim-icon {
    width: 1.9em;
    height: 1.9em;
    margin: 10px;
    font-size: 16px;
    display: inline-block;
    position: absolute;
    top: 5px;
    right: 5px;
    vertical-align: middle;
}
.anim-icon input {
    display: none;
}
.anim-icon label {  
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    border: .1em solid #ccc;
    border-radius: 100%;
    display: block;
    font: normal normal normal 13px/1 FontAwesome;
    color: #ccc;
    font-size: inherit;
    text-rendering: auto;
    -webkit-font-smoothing: antialiased;
    cursor: pointer;
}
.anim-icon label:after {
    left: 0;
    top: 50%;
    margin-top: -0.5em;
    display: block;
    position: relative;
    text-align: center;
}
.anim-icon input:checked + label {
    animation: check-in .3s forwards;
    transition: background-color .1s .2s, box-shadow 1s;
    border-width: .1em;
    border-style: solid;
}
.anim-icon input:checked + label:after {
    animation: icon .3s forwards;
}


.result-card-list img{
    height: 175px;
    width: 175px;
}


@keyframes icon {
    0% {
        margin-top: -0.5em;
        font-size: 1.5em;
   }
    100% {
        font-size: 1em;
        opacity: 1;
        color: white;
   }
}
@keyframes check-in {
    0% {
        left: 20%;
        top: 20%;
        width: 60%;
        height: 60%;
   }
    80% {
        left: -5%;
        top: -5%;
        width: 110%;
        height: 110%;
   }
    100% {
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
   }
}
@keyframes check {
    0% {
        left: 5%;
        top: 5%;
        width: 90%;
        height: 90%;
   }
    10% {
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
   }
    80% {
        left: -5%;
        top: -5%;
        width: 110%;
        height: 110%;
   }
    90% {
        left: 5%;
        top: 5%;
        width: 90%;
        height: 90%;
   }
    100% {
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
   }
}

</style>

<div class="content">
    <div class="container-fluid">
        <h1 class="mb-4 fw-semibold text-capitalize d-flex align-items-center main-title fs-3">
            Welcome <%- locals.firstName.charAt(0).toUpperCase() + locals.firstName.slice(1).toLowerCase() %>
            <img class="ms-2" src="/assets/waveing-hand.svg" style="width: 32px; height: 32px;" alt="">
        </h1>

        <div class="row">
            
            <!-- Concentration Settings Card -->
            <div class="col-sm-12 col-lg-6 col-xl-5 mb-3 mb-lg-0">
                <div class="card p-3">
                    <div class="w-100 d-flex flex-column h-100 gap-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1 class="m-0 card-title">Set MBA Concentration</h1>
                            <a href="#" role="button" class="event-btn-link <%= biddingRounds.length > 0 ? 'd-none' : '' %>" id="edit-concentration-btn">Edit</a>
                        </div>
                        <div class="" id="concentration-title">
                            <h1 class="m-0 fs-3 fw-semibold text-capitalize"> <%= studentDetails && studentDetails.concentrationName !== undefined ? studentDetails.concentrationName : "NA" %> </h1>
                        </div>
                        <div class="w-100 d-flex flex-column flex-md-row justify-content-center gap-md-2 justify-content-md-between align-items-start d-none" id="concentration-settings-div">
                            <select id="set-concentration" class="col-12 col-md-9">
                                <option value="" disabled selected>Select Concentration</option>
                                <% concentrationList?.forEach(concentration => { %>
                                    <option value="<%= concentration.id %>" <%= studentDetails?.concentration === concentration.id ? "selected" : "" %>><%= concentration.concentration_name %></option>
                                <% }) %>
                            </select>
                            <button class="col-12 col-md-3 mt-2 mt-md-0 p-0 btn event-btn" 
                                style="height: 34px !important;" 
                                id="confirm-concentration-btn"
                            >
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Credits Information Card  -->
            <div class="col-sm-12 col-lg-6 col-xl-7">
                <div class="card p-3 h-100">
                    <div class="w-100 h-100  d-flex flex-column gap-2 justify-content-between">
                        <h1 class="m-0 card-title">Credits Information</h1>
                        <div class="row">
                            <!-- <div class="col-6 col-xl-4 d-flex flex-column text-danger">
                                <span class="fs-7">Trimester Creds</span>
                                <span class="m-font-xxl fw-semibold ms-1">15</span>
                            </div> -->
                            <div class="col-6 col-xl-4 d-flex flex-column">
                                <span class="">Bidding Name</span>
                                <span class="info-title">
                                    <%= locals.biddingName && locals.biddingName !== undefined ? locals.biddingName : "NA" %>
                                </span>
                            </div>
                            <div class="col-6 col-xl-4 d-flex flex-column">
                                <span class="">Yearly Creds</span>
                                <span class="info-title">
                                    <%= yearlyCredits && yearlyCredits.annually_credits_count !== undefined ? yearlyCredits.annually_credits_count : "NA" %>
                                </span>
                            </div>
                            <div class="col-6 col-xl-4 d-flex flex-column mt-2 mt-xl-0">
                                <span class="">Confirm Creds</span>
                                <span class="info-title text-danger">
                                    0
                                </span>
                            </div>
                            <div class="col-6 col-xl-4 d-flex flex-column mt-2 mt-xl-1">
                                <span class="">Total Bid Pts</span>
                                <span class="info-title">
                                    <%= studentDetails && studentDetails.bid_points !== undefined ? studentDetails.bid_points : "NA" %>
                                </span>
                            </div>
                            <div class="col-6 col-xl-4 d-flex flex-column mt-2 mt-xl-1">
                                <span class="">Rem Bid Pts</span>
                                <span class="info-title">
                                    <%= studentDetails && studentDetails.remaining_bid_points !== undefined ? studentDetails.remaining_bid_points : 'NA' %>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="row mt-4">

            <!-- Completed Rounds Result Card  -->
            <div class="col-sm-12 col-lg-6 col-xl-8 mb-4 mb-lg-0">
                <div class="card p-3" style="height: 375px;">
                    <div class="d-flex flex-column gap-2  h-100">
                        <div class="d-flex flex-column flex-xl-row justify-content-center gap-md-1 justify-content-xl-between align-items-start align-items-xl-center">
                            <span class="card-title">Completed Round Result</span>
                            <select id="set-completed-round" class="col-12 col-xl-6">
                                <% if (biddingRounds.length > 0) { %>
                                    <option value="" selected disabled>Select Round</option>
                                    <!-- <% const currentDate = new Date() %>
                                    <% biddingRounds.forEach(function(round) { %>
                                        <% const endDate = new Date(round.end_date_time) %>
                                        <% if (endDate < currentDate) { %>
                                            <option value="<%= round.round_id %>"><%= round.round_name %></option>
                                        <% } %>
                                    <% }) %> -->
                                    <% biddingRounds.forEach(function(round) { %>
                                        <option value="<%= round.round_id %>"><%= round.round_name %></option>
                                    <% }) %>
                                <% } else { %>
                                    <option value="" >No Rounds</option>
                                <% } %>
                            </select>
                        </div>
                        <div class="row result-card-list flex-grow-1 overflow-y-auto">
                            <div class="d-flex flex-column justify-contrent-center align-items-center my-auto">
                                <h1 class="mt-2 fs-6 fst-italic font-medium">
                                    <%= biddingRounds.length > 0 ? "Select Round" : "No Rounds Data" %>
                                </h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- Notifications Round Card -->
            <div class="col-sm-12 col-lg-6 col-xl-4 ">
                <div class="card p-3" style="height: 375px;">
                    <div class="w-100 d-flex flex-column h-100 gap-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="card-title m-0">Notifications</span>
                            <span class="fs-7 m-0" id="current-time-clock"></span>
                        </div>
                        <div class="flex-grow-1 overflow-y-auto" id="notifications-div">
                            <div class="w-100">
                                <p class="mb-2 fs-7 fst-italic d-flex align-items-center">
                                    <img class="me-1" src="/assets/fluent_live-24-regular.svg"
                                        style="width: 20px; height: 20px;" alt="">
                                    Live Round
                                </p>
                                <div class="card p-2 d-flex flex-row align-items-center gap-3 live-round">
                                    <div class="d-flex justify-content-center align-items-center rounded-circle"
                                        style="width: 50px; height: 50px; background-color: rgba(210, 35, 42, .1);">
                                        <img class="round-img" src="/assets/trophy.svg" alt="">
                                    </div>
                                    <div class="flex-grow-1 d-flex flex-column gap-1">
                                        <h1 class="m-0 fs-7 fw-normal"></h1>
                                        <p
                                            class="m-0 d-flex align-items-center gap-1 fs-7 fw-semibold text-danger">
                                            <img class="time-img" src="/assets/ClockOutline.svg"
                                                style="width: 18px; height: 18px;" alt="">
                                            <span class="live-time"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-2" />
                            <div class="w-100 d-flex flex-column gap-2">
                                <p class="m-0 fs-7 fst-italic d-flex align-items-center">
                                    <img class="me-1"
                                        src="/assets/material-symbols-light_event-upcoming-outline-rounded.svg"
                                        style="width: 20px; height: 20px;" alt="">
                                    Upcoming Round
                                </p>
                                <!-- <div class="card p-2 d-flex flex-row align-items-center gap-3">
                                    <div class="d-flex justify-content-center align-items-center rounded-circle"
                                        style="width: 50px; height: 50px; background-color: rgba(210, 35, 42, .1);">
                                        <img class="round-img" src="../assets/BadgeCheckOutline.svg" alt="">
                                    </div>
                                    <div class="flex-grow-1 d-flex flex-column gap-1">
                                        <h1 class="m-0 fs-7 fw-normal">Course Confirmation Round I</h1>
                                        <p class="m-0 d-flex align-items-center gap-1 fs-7 fw-semibold">
                                            <img class="time-img" src="./assets/ClockOutline.svg" style="width: 18px; height: 18px;" alt="">
                                            10-06-2024
                                        </p>
                                    </div>
                                </div> -->
                                <% for (let i = 0; i < 2; i++) { %>
                                    <div class="card p-2 d-flex flex-row align-items-center gap-3 upcoming-round">
                                        <div class="d-flex justify-content-center align-items-center rounded-circle"
                                            style="width: 50px; height: 50px; background-color: rgba(210, 35, 42, .1);">
                                            <img class="round-img" src="" alt="">
                                        </div>
                                        <div class="flex-grow-1 d-flex flex-column gap-1">
                                            <h1 class="m-0 fs-7 fw-normal round-name"></h1>
                                            <p class="m-0 d-flex align-items-center gap-1 fs-7 fw-semibold round-endDate"></p>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class=" width-100 mt-4">
            <div class="col-12">
                <div class="card p-3">
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed card-title m-0" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false"
                                    aria-controls="collapseOne">
                                    Available Course List
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <div class="row my-2">
                                        <form class="col-12 col-md-6 col-lg-4">
                                            <div class="form-group">
                                                <select multiple id="select-trimister" class="form-control fs-6"
                                                    placeholder="Select Trimister...">
                                                    <option value="">Set Academic Sessions</option>
                                                    <optgroup label="Trimister">
                                                        <% acadSessionsList.forEach(session => { %>
                                                            <option value="<%= session.acad_session %>"><%= session.acad_session %></option>
                                                        <% })%>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </form>
    
                                        <form class="col-12 col-md-6 col-lg-4 ">
                                            <div class="form-group">
                                                <select multiple id="select-areas" class="form-control fs-6"
                                                    placeholder="Select Areas...">
                                                    <option value="">Set Areas</option>
                                                    <optgroup label="Area">
                                                        <% areaNameList.forEach(area => { %>
                                                            <option value="<%= area.area_name %>"><%= area.area_name %></option>
                                                        <% })%>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </form>
    
                                        <form class="col-12 col-md-6 col-lg-4 ">
                                            <div class="form-group">
                                                <select multiple id="select-courses" class="form-control fs-6"
                                                    placeholder="Select Courses...">
                                                    <option value="">Set Courses</option>
                                                    <optgroup label="Courses">
                                                        <% courseNameList.forEach(course => { %>
                                                            <option value="<%= course.course_name %>"><%= course.course_name %></option>
                                                        <% })%>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </form>
                                    </div>
    
                                    <!-- loader -->
                                    <div class="loader">
                                        <img src="../assets/Dual-Ball.svg" alt="loader">
                                    </div>
                                    
                                    <div class="row accordion-card-list">
                                        <% if(availableCoursesList.length > 0){ %>
                                            <% availableCoursesList.forEach(course => { %>
                                                <div class="col-xxl-4 col-lg-6 col-12 mt-2 d-flex">
                                                    <div class="card p-3 w-100">
                                                        <h1 class="fs-6"><%= course.course_name %></h1>
                                                        <h1 class="fs-7 text-body-tertiary"><%= course.area_name %></h1>
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/academic-cap.svg" alt="Trimester">
                                                                    <h1 class="m-0 fs-7
                                                                    w-medium"><%= course.acad_session %></h1>
                                                                </div>
                                                            </div>
                                                            <div class="col-6 ">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/CurrencyRupeeOutline.svg" alt="Points">
                                                                    <h1 class="m-0 fs-7 fw-medium"><%= course.credits %> credits</h1>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row mt-2">
                                                            <div class="col-6">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/Chair.svg" alt="Points">
                                                                    <h1 class="m-0 fs-7 fw-medium"><%= course.total_seat %> seats</h1>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/Book-Icon.svg" alt="Points">
                                                                    <h1 class="m-0 fs-7 fw-medium"><%= course.course_id %></h1>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row mt-2">
                                                            <div class="col-12">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/ClockOutline-1.svg" alt="Clock">
                                                                    <h1 class="m-0 fs-7 fw-medium"><%= course.course_timeing %></h1>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="row mt-2">
                                                            <div class="col-12">
                                                                <div class="d-flex align-items-start align-items-md-center gap-2">
                                                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/Person.svg" alt="Teacher">
                                                                    <h1 class="m-0 fs-7 fw-medium">
                                                                        <%
                                                                            const names = course.faculty_name.split('/')
                                                                            const uniqueNameSet = new Set(names)
                                                                            const uniqueNames = Array.from(uniqueNameSet).join('. ')
                                                                        %>
                                                                        <%= uniqueNames %>
                                                                    </h1>
                                                                </div>
                                                            </div>
                                                        </div>
                                                         <div class="anim-icon star">
                                                            <input type="checkbox" id="star-<%= course.division_id %>" <%= course.is_favourite ? 'checked' : '' %>>
                                                            <label for="star-<%= course.division_id %>"></label>
                                                         </div>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        <% }else{ %>
                                            <h1 class="m-0 mt-4 fs-6 fw-normal fst-italic text-center">No Courses Yet</h1>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<%- include("../partials/footer") %>

<script>

    setActiveMenuItem(`<%- active %>`)

    $("#set-concentration").selectize()
    $("#set-completed-round").selectize()

    $("#select-trimister").selectize({
        plugins: ['remove_button'],
        sortField: 'text'
    })

    $("#select-areas").selectize({
        plugins: ['remove_button'],
        sortField: 'text'
    })

    $("#select-courses").selectize({
        plugins: ['remove_button'],
        sortField: 'text'   
    })

    const socket = io()

    const trimisterSelect = $('#select-trimister')[0].selectize
    const areaSelect = $('#select-areas')[0].selectize
    const courseSelect = $('#select-courses')[0].selectize

    const studentConcentration = `<%- studentDetails?.concentrationName %>`
    // const biddingRounds = `<%- JSON.stringify(biddingRounds) %>`
    // console.log(biddingRounds)

    if(!studentConcentration){
        $("#concentration-title").addClass("d-none")
        $("#concentration-settings-div").removeClass("d-none")
        $("#edit-concentration-btn").addClass("d-none")
    }

    $("#edit-concentration-btn").on("click", function(event){
        event.preventDefault()
        const isSettingsVisible = !$("#concentration-settings-div").hasClass("d-none")
        
        if (isSettingsVisible) {
            $("#concentration-settings-div").addClass("d-none")
            $("#concentration-title").removeClass("d-none")
            $("#edit-concentration-btn").html("Edit")
        } else {
            $("#concentration-settings-div").removeClass("d-none")
            $("#concentration-title").addClass("d-none")
            $("#edit-concentration-btn").html(`<i class="fa-solid fa-x fs-5"></i>`)
        }
    })

    $("#confirm-concentration-btn").on("click", function(){
        const concentrationId = $("#set-concentration")[0].selectize.items[0]
        const concentrationName = $("#set-concentration option:selected").text()

        let ApiObj = {
            type : "POST",
            url : "/student/dashboard/save-concentration",
            data : {
                concentrationId : concentrationId,
                concentrationName : concentrationName
            },
            datatype : JSON
        }

        ajaxApi(ApiObj).then(result => {
            toast.success(result.description)
            setTimeout(()=>{
                location.reload()
            },[3000])
        }).catch(err => {
            console.log(err)
            toast.error(err.responseJSON.description)
        })
    })


    $("#set-completed-round").on("change", function(){
        const selectedRoundId = $("#set-completed-round")[0].selectize.items[0]
        const selectedRoundName = $("#set-completed-round option:selected").text()
        let ApiObj = {
            type : "POST",
            url : "/student/dashboard/completed-round",
            data : {
                roundId : selectedRoundId
            },
            datatype : JSON
        }
        
        ajaxApi(ApiObj).then(result =>{
            console.log(result)
            if(result.length === 0){
                const roundResultList = $(".result-card-list")
                roundResultList.empty()
                const displayDiv = `
                    <div class="d-flex flex-column justify-contrent-center align-items-center my-auto">
                        <h1 class="mt-2 fs-6 fst-italic">You did not participate in <span class="fw-medium">${selectedRoundName}</span></h1>
                    </div>
                `
                roundResultList.append(displayDiv)
            }else{
                renderCompletedCourses(result)
            }
        }).catch(err =>{
            console.log(err)
        })
        
    })

    trimisterSelect.on('change', handleFilterInputChange)
    areaSelect.on('change', handleFilterInputChange)
    courseSelect.on('change', handleCourseInputChange)

    function fetchAllCourses(){
    
        let ApiObj = {
            type : "GET",
            url : "/student/dashboard/all-courses",
            data : {},
            datatype : JSON
        }

        ajaxApi(ApiObj).then(result =>{
            renderFilteredCourses(result)
            // attachFavoriteListeners()
        }).catch(err => {
            toast.error(err.responseJSON.description)
        })
        
    }

    function applyFilters(){
        const trimisterInputs = trimisterSelect.getValue()
        const areaInputs = areaSelect.getValue()

        const inputs = {
            trimister: trimisterInputs,
            area: areaInputs
        }

        $(".loader").css({
            display: "flex",
            justifyContent: "center",
            alignItems: "center"
        });
        $(".accordion-card-list").css("opacity", "0.5");

        let ApiObj = {
            type: "POST",
            url: "/student/dashboard/filter-courses",
            data: { filterInputs: inputs },
            contentType: "application/json",
            dataType: JSON
        };

        ajaxApi(ApiObj)
        .then(result => {
            renderFilteredCourses(result)
            updateCourseSelectOptions(result)
        })
        .catch(err => {
            console.log("Error occurred:", err.responseJSON?.description || err.message);
            toast.error(err.responseJSON?.description || "An unexpected error occurred.");
        })

        $(".loader").hide()
        $(".accordion-card-list").css("opacity", "1")
    }

    function updateCourseSelectOptions(courses){
        courseSelect.clear()
        console.log("here")
        const uniqueCourses = new Set();
        courses.forEach(course => {
            const courseName = course.course_name.split('-')[0].trim();
    
        // Check if the course name already exists in the object
            if (!uniqueCourses[courseName]) {
                // Add the course name to the object
                uniqueCourses[courseName] = true;
                
                // Add the unique course name to courseSelect options
                courseSelect.addOption({ value: courseName, text: courseName });
            }
        })

        uniqueCourses.forEach(courseName => {
            courseSelect.addOption({value : courseName, text : courseName})
        })
    }

    function handleFilterInputChange(){
        const trimisterInputs = trimisterSelect.getValue()
        const areaInputs = areaSelect.getValue()
        const courseInputs = courseSelect.getValue()

        if (trimisterInputs.length === 0 && areaInputs.length === 0 && courseInputs.length === 0) {
            fetchAllCourses()
        } else {
            applyFilters()
        }
    }

    function handleCourseInputChange(){
        const courseInputs = courseSelect.getValue()

        if(courseInputs.length === 0){
            if(trimisterSelect.getValue().length===0 && areaSelect.getValue().length===0){
                fetchAllCourses()
            }else{
                applyFilters()
            }
        }else{
            try{
                let ApiObj = {
                    type : "POST",
                    url : "/student/dashboard/search-courses",
                    data : {
                        coursesNames : courseInputs
                    },
                    datatype : JSON
                }

                ajaxApi(ApiObj).then(result => {
                    renderFilteredCourses(result)
                    // attachFavoriteListeners()
                }).catch(err =>{
                    console.log(err)
                    toast.error(err.responseJSON.description)
                })
                
            }catch(error){
                console.log('error occured in course search api call :',error.message)
            }
        }
    }

    $(document).on('change', '.anim-icon.star input[type="checkbox"]', function() {
        const divId = this.id.split('-')[1]
        const isFavourite = this.checked ? 1 : 0

        let ApiObj = {
            type: "POST",
            url: "/student/dashboard/add-favourite",
            data: {
                divId: divId,
                isFavourite: isFavourite
            },
            dataType: "json"
        }

        ajaxApi(ApiObj).then(result => {
            toast.success(result.description)
        }).catch(err => {
            toast.error(err.responseJSON.description);
        })
    })

    // function attachFavoriteListeners(){
    //     console.log('here')
    //     $(document).on('change', '.anim-icon.star input[type="checkbox"]', function() {
    //         console.log('Checkbox clicked');
    //         const divId = this.id.split('-')[1];
    //         const isFavourite = this.checked ? 1 : 0;

    //         console.log('Checkbox state changed');

    //         const favCourse = {
    //             student_lid: 1,
    //             div_batch_lid: divId,
    //             is_favourite: isFavourite
    //         };

    //         let ApiObj = {
    //             type: "POST",
    //             url: "/student/dashboard/add-favourite",
    //             data: {
    //                 addFavCourse: favCourse
    //             },
    //             dataType: "json"
    //         };

    //         ajaxApi(ApiObj).then(result => {
    //             console.log(result);
    //         }).catch(err => {
    //             console.log(err);
    //             toast.error(err.responseJSON.description);
    //         });
    //     });
    // }

    function renderCompletedCourses(courses){
        const roundResultList = $(".result-card-list")
        roundResultList.empty()
        courses.forEach(course => {
            const courseCard = `
                <div class="col-xl-6 col-12 mt-2 d-flex">
                    <div class="card p-3 w-100 d-flex flex-col justify-content-between gap-2">
                        <h1 class="m-0 fs-6 fw-medium">${course.course_name}</h1>
                        <h1 class="m-0 text-body-tertiary fs-7">${course.area_name}</h1>
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <div class="d-flex align-items-center gap-2">
                                    <img src="/assets/icon_svgs/academic-cap.svg" style="width: 18px; height: 18px;">
                                    <span class="m-0 fw-medium">${course.acad_session}</span>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 mt-1 mt-md-0">
                                <div class="d-flex align-items-center gap-2">
                                    <img src="/assets/icon_svgs/CurrencyRupeeOutline.svg" style="width: 18px; height: 18px;">
                                    <span class="m-0 fw-medium">${course.credits} credits</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
            roundResultList.append(courseCard)
        })
    }

    function renderFilteredCourses(courses){
        $(".accordion-card-list").empty()
        courses.forEach(course => {
            const courseCard = `
                <div class="col-xxl-4 col-lg-6 col-12 mt-2 d-flex">
                    <div class="card p-3 w-100">
                        <h1 class="fs-6">${course.course_name}</h1>
                        <h1 class="fs-7 text-body-tertiary">${course.area_name}</h1>
                        <div class="row">
                            <div class="col-6">
                                <div class="d-flex align-items-center gap-2">
                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/academic-cap.svg" alt="Trimester">
                                    <h1 class="m-0 fs-7 fw-medium">${course.acad_session}</h1>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center gap-2">
                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/CurrencyRupeeOutline.svg" alt="Points">
                                    <h1 class="m-0 fs-7 fw-medium">${course.credits} credits</h1>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <div class="d-flex align-items-center gap-2">
                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/Chair.svg" alt="Points">
                                    <h1 class="m-0 fs-7 fw-medium">${course.total_seat} seats</h1>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center gap-2">
                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/book-icon.svg" alt="Points">
                                    <h1 class="m-0 fs-7 fw-medium">${course.course_id}</h1>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="d-flex align-items-center gap-2">
                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/ClockOutline-1.svg" alt="Clock">
                                    <h1 class="m-0 fs-7 fw-medium">${course.course_timeing}</h1>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="d-flex align-items-start align-items-md-center gap-2">
                                    <img style="width: 16px; height: 16px;" src="/assets/icon_svgs/Person.svg" alt="Teacher">
                                    <h1 class="m-0 fs-7 fw-medium">
                                        ${[...new Set(course.faculty_name.split('/'))].join('. ')}
                                    </h1>
                                </div>
                            </div>
                        </div>
                        <div class="anim-icon star">
                            <input type="checkbox" id="star-${course.division_id}" ${course.is_favourite ? 'checked' : ''}>
                            <label for="star-${course.division_id}"></label>
                        </div>
                    </div>
                </div>
            `

            $(".accordion-card-list").append(courseCard)
        })
        // attachFavoriteListeners()
    }

    function updateClock(startTime){
        setInterval(() => {
            // Calculate the current time based on the server-provided startTime

            const currentTime = new Date(startTime + (new Date().getTime() - startTime));
            console.log(currentTime); // Debugging output
            $("#current-time-clock").text(currentTime.toLocaleTimeString());
        }, 1000)
    }

    socket.on('time', (serverTime) => {
        // const startTime = new Date(serverTime).getTime()
        // console.log(serverTime)
        // updateClock(startTime)
        $("#current-time-clock").text(serverTime)
    })
    

</script>

<%- include("../partials/footerEnd") %>
